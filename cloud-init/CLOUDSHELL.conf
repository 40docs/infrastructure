#cloud-config

timezone: America/Toronto
package_update: true
package_upgrade: true
package_reboot_if_required: true

bootcmd:
  - mkdir -p /home /var/lib/docker /root/.ollama
  - |
    format_and_mount() {
      local lun="$1" label="$2" mount_point="$3" always_format="$4"
      local dev="/dev/disk/azure/scsi1/lun$${lun}"
      local part="$${dev}-part1"

      echo "[INFO] Waiting for $dev ..."
      for i in $(seq 1 30); do
        if [ -b "$dev" ]; then
          echo "[INFO] $dev detected."
          break
        fi
        sleep 2
      done

      if [[ "$always_format" == "yes" ]]; then
        echo "[INFO] Formatting $dev (forced) for $mount_point ..."
        parted -s "$dev" mklabel gpt mkpart primary ext4 0% 100%
        mkfs.ext4 -F "$part" -L "$label"
      else
        if ! blkid "$part" >/dev/null 2>&1; then
          echo "[INFO] No filesystem on $dev — formatting for $mount_point ..."
          parted -s "$dev" mklabel gpt mkpart primary ext4 0% 100%
          mkfs.ext4 -F "$part" -L "$label"
        else
          echo "[INFO] Filesystem already exists on $dev — preserving data."
        fi
      fi

      mount -o defaults,nofail LABEL="$label" "$mount_point"
    }

    format_and_mount 0 homefs /home yes
    format_and_mount 1 dockerfs /var/lib/docker no
    format_and_mount 2 ollamafs /root/.ollama no

